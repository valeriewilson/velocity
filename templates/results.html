{% extends 'base.html' %}
{% block content %}

    <h2>Results</h2>
    
    <p>Miles: {{ miles }} miles | Time: {{ minutes }} minutes | Total climb: {{ "{:.0f}".format(elevation) }} ft</p>
    
    <div>
        <p>Do you want to save this route?</p>
        
        <div>
            <input type="radio" name="save-option" value="yes" id="yes-option"> Yes<br>
            <form action="/add-score" id="accepted-route-form" method="POST" class="hidden">
                <select name="rating" id="rating">
                    <option>1</option>
                    <option>2</option>
                    <option>3</option>
                    <option>4</option>
                    <option>5</option>
                </select>
                <input type="submit" value="Save" id="save-rating">
            </form>
        </div>

        <div>
            <input type="radio" name="save-option" value="no" id="no-option"> No<br>
            <form action="/reject-route" id="rejected-route-form" method="POST" class="hidden">
                <select name="issue" id="issue">
                    <option id="impossible">Impossible route</option>
                    <option id="traffic">Major roads / traffic</option>
                    <option id="no-lanes">No bike lanes</option>
                    <option id="dont-like">Not feeling it</option>
                    <option id="overlapped">Overlapped sections</option>
                </select>
                <input type="submit" value="Save" id="save-reason">
            </form>
        </div>

    </div>
    <br>

    <div id="map"></div>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&callback=initMap">
    </script>

    <script src="https://code.jquery.com/jquery.js"></script>

    <script>
        "use strict";

        var yes_selected = document.getElementById("yes-option");
        yes_selected.onchange = function(){
            $('#accepted-route-form').removeClass();
            $('#rejected-route-form').addClass("hidden");
        }

        var no_selected = document.getElementById("no-option");
        no_selected.onchange = function(){
            $('#accepted-route-form').addClass("hidden");
            $('#rejected-route-form').removeClass();
        }

        function initMap() {
            var waypoints = {{ waypoints }};
            var mid_lat = {{ mid_lat }};
            var mid_lon = {{ mid_lon }};

            var midpoint = {"lat": mid_lat, "lng": mid_lon};
            var start_point = {"lat": waypoints[0][0], "lng": waypoints[0][1]}

            // Instantiate map
            var directionsService = new google.maps.DirectionsService;
            var directionsDisplay = new google.maps.DirectionsRenderer({suppressMarkers: true});

            // Configure map, pass lat/lon pairs to displayRoute
            var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 25,
                center: midpoint,
                mapTypeControl: false,
                streetViewControl: false,
            });

            // Place marker for start/end point
            var marker = new google.maps.Marker({
              position: start_point,
              map: map
            });

            // Display map based on configuration
            directionsDisplay.setMap(map);

            // Call displayRoute function to display bike route
            displayRoute(directionsService, directionsDisplay, waypoints);
        }

        function displayRoute(directionsService, directionsDisplay, waypoints) {

            // Prepare start/end point
            var start_lat = waypoints[0][0];
            var start_lng = waypoints[0][1];
            var start_point = start_lat + ', ' + start_lng;

            // Prepare waypoints along route
            var waypts = [];

            for (var i = 1; i < waypoints.length; i++) {
                waypts.push({location: String(waypoints[i][0]) + ', ' + String(waypoints[i][1])})
            }

            // Create route, starting & ending at origin, passing through waypoints
            directionsService.route({
                origin: start_point,
                destination: start_point,
                waypoints: waypts,
                travelMode: 'BICYCLING'
            },

            // Error handling
            function(response, status) {
                if (status === 'OK') {
                    directionsDisplay.setDirections(response);
                } else {
                    console.log('Directions request failed due to ' + status);
                }
            });
        }

    </script>
{% endblock %}