{% extends 'base.html' %}
{% block content %}
    <p>Total climb: {{ "{:.0f}".format(elevation * 3.28) }} ft</p>
    <div id="map" class="work"></div>

    <div>
        <p>Do you want to save this route?</p>
        <div>
            <input type="radio" name="save-option" value="yes" id="yes-option"> Yes<br>
            <form action="/add-score" id="accepted-route-form" method="POST" class="hidden">
                <select name="rating" id="rating">
                    <option>1</option>
                    <option>2</option>
                    <option>3</option>
                    <option>4</option>
                    <option>5</option>
                    <input type="submit" value="Save" id="save-rating">
                </select>
            </form>
        </div>
        <div>
            <input type="radio" name="save-option" value="no" id="no-option"> No<br>
            <form action="/reject-route" id="rejected-route-form" method="POST" class="hidden">
                <select name="issue" id="issue">
                    <option id="impossible">Impossible route</option>
                    <option id="traffic">Major roads / traffic</option>
                    <option id="no-lanes">No bike lanes</option>
                    <option id="dont-like">Not feeling it</option>
                    <option id="overlapped">Overlapped sections</option>
                    <input type="submit" value="Save" id="save-reason">
                </select>
            </form>
        </div>
    </div>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&callback=initMap">
    </script>
    <script src="https://code.jquery.com/jquery.js"></script>
    <script>
        "use strict";

        var yes_selected = document.getElementById("yes-option");
        yes_selected.onchange = function(){
            $('#accepted-route-form').removeClass()
            $('#rejected-route-form').addClass("hidden")
        }

        var no_selected = document.getElementById("no-option");
        no_selected.onchange = function(){
            $('#accepted-route-form').addClass("hidden")
            $('#rejected-route-form').removeClass()
        }

        function initMap() {
            var directionsService = new google.maps.DirectionsService;
            var directionsDisplay = new google.maps.DirectionsRenderer({suppressMarkers: true});
            var start = {lat: {{ lat_1 }}, lng: {{ lon_1 }}};
            var mid_1 = {lat: {{ lat_2 }}, lng: {{ lon_2 }}};
            var mid_2 = {lat: {{ lat_3 }}, lng: {{ lon_3 }}};

            // Center map around midpoint of all lat/lon pairs, calculated below
            var max_lat = Math.max({{lat_1}}, {{lat_2}}, {{lat_3}})
            var min_lat = Math.min({{lat_1}}, {{lat_2}}, {{lat_3}})
            var mid_lat = min_lat + ((max_lat - min_lat) / 2)

            var max_lon = Math.max({{lon_1}}, {{lon_2}}, {{lon_3}})
            var min_lon = Math.min({{lon_1}}, {{lon_2}}, {{lon_3}})
            var mid_lon = min_lon + ((max_lon - min_lon) / 2)

            var center_position = {lat: mid_lat, lng: mid_lon}
            var map = new google.maps.Map(document.getElementById('map'), {
              zoom: 25,
              center: center_position,
              mapTypeControl: false,
              streetViewControl: false
            });
            var marker = new google.maps.Marker({
              position: start,
              map: map
            });
            directionsDisplay.setMap(map);
            displayRoute(directionsService, directionsDisplay);
        }

        function displayRoute(directionsService, directionsDisplay) {
            directionsService.route({
            origin: '{{ lat_1 }}, {{ lon_1 }}',
            destination: '{{ lat_1 }}, {{ lon_1 }}',
            waypoints: [{location: '{{ lat_2 }}, {{ lon_2 }}'}, {location: '{{ lat_3 }}, {{ lon_3 }}'}],
            travelMode: 'BICYCLING'
        }, function(response, status) {
            if (status === 'OK') {
                directionsDisplay.setDirections(response);
            } else {
                console.log('Directions request failed due to ' + status);
            }
            });
        }

    </script>
{% endblock %}