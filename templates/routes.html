{% extends 'base.html' %}
{% block title %}Routes{% endblock %}
{% block content %}

    <h2>Routes</h2>

    <h3>Filter options</h3>

    <form action="/filter" method="GET" id="filter-form" novalidate>

        <b>Route Type</b>
        <br>
        <input type="radio" name="route-approval" value="True" id="accepted-routes" checked>Accepted<br>
        <input type="radio" name="route-approval" value="False" id="rejected-routes">Rejected<br>

        <br>
        <b>Total Miles</b>
        <div id="mile-range">
            <label for="min-miles">Min:</label>
            <input type="min-miles" id="min-miles" class="miles" name="min-miles" placeholder="0">

            <label for="max-miles">Max:</label>
            <input type="max-miles" id="max-miles" class="miles" name="max-miles" placeholder="1000">
        </div>

        <br>
        <b>Total Time (minutes)</b>
        <div id="time-range">
            <label for="min-minutes">Min:</label>
            <input type="min-minutes" id="min-minutes" class="minutes" name="min-minutes" placeholder="0">

            <label for="max-minutes">Max:</label>
            <input type="max-minutes" id="max-minutes" class="minutes" name="max-minutes" placeholder="1000">
        </div>

        <br>
        <b>Total Elevation (feet)</b>
        <div id="elevation-range">
            <label for="min-elevation">Min:</label>
            <input type="min-elevation" id="min-elevation" class="elevation" name="min-elevation" placeholder="0">

            <label for="max-elevation">Max:</label>
            <input type="max-elevation" id="max-elevation" class="elevation" name="max-elevation" placeholder="5000">
        </div>
        <br>

        <div id="score-range">
            <b>Score</b>
            <br>

            <label for="min-score">Min:</label>
            <input type="min-score" id="min-score" class="score" name="min-score" placeholder="0">
            
            <label for="max-score">Max:</label>
            <input type="max-score" id="max-score" class="score" name="max-score" placeholder="5">
            <br>
            <br>
        </div>

        <div>
            Sort By: <select name="sort-options" id="sort-dropdown">
                <option id="sort-option" value="score">Score</option>
                <option id="sort-option" value="route-id">Date created</option>
                <option id="sort-option" value="time">Time</option>
                <option id="sort-option" value="elevation">Elevation</option>
                <option id="sort-option" value="miles">Miles</option>
            </select>

            <input type="radio" name="sort-method" value="asc" id="asc">Asc
            <input type="radio" name="sort-method" value="desc" id="desc" checked>Desc<br>
        <div>

        <br>
        <input type="submit" value="Apply" id="submit-button">
        <br>

    </form>
    <br>

    {% for route in routes %}

        <div id="saved-routes">
            <div class="map" id="map{{ route.route_id }}" data-id="{{ route.route_id }}"></div>
            <p>{{ route.total_miles }} miles | {{ route.total_minutes | int }} minutes | {{ "{:.0f}".format(route.total_ascent) }} ft</p>
            
            {% if route.is_accepted == True %}
                <p>Score: {{ route.score }}</p>
            {% else %}
                <p>Issue: {{ route.issue }}</p>
            {% endif %}
        </div>

    {% endfor %}

<script async defer
    src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&callback=retrieveWaypoints">
</script>

<script src="https://code.jquery.com/jquery.js"></script>

<script>

    $('#accepted-routes').on('change', function () {
        // Display "score" fields if "Accepted" is selected for route type
        $('#score-range').removeClass()
    });

    $('#rejected-routes').on('change', function () {
        // Hide "score" fields if "Rejected" is selected for route type
        $('#score-range').addClass("hidden")
    });

    function retrieveWaypoints() {
        // Get list of maps
        var maps = document.getElementsByClassName('map');
        
        // Get route_id associated with each map, pass to waypoints route
        for (var i = 0; i < maps.length; i++) {
            var route_num = maps[i].getAttribute("data-id");
            $.get("/waypoints.json", {"route-id": route_num}, initMap);
        }
    }

    function initMap(data) {

        // Extract data returned from waypoints endpoint
        var waypoints = data.waypoints;
        var midpoint = data.midpoint;
        var route_id = data.route_id;

        // Instantiate map
        var directionsService = new google.maps.DirectionsService;
        var directionsDisplay = new google.maps.DirectionsRenderer({suppressMarkers: true});
        var map_id = "map" + String(route_id);

        // Configure map, pass lat/lon pairs to displayRoute
        var map = new google.maps.Map(document.getElementById(map_id), {
            zoom: 25,
            center: midpoint,
            mapTypeControl: false,
            streetViewControl: false
        });
        
        // Place marker for start/end point
        var marker = new google.maps.Marker({
            position: waypoints[0],
            map: map
        });

        // Display map based on configuration
        directionsDisplay.setMap(map);

        // Call displayRoute function to display bike route
        displayRoute(directionsService, directionsDisplay, waypoints);
    }

    function displayRoute(directionsService, directionsDisplay, waypoints) {

        // Prepare start/end point
        var start_lat = waypoints[0]["lat"];
        var start_lng = waypoints[0]["lng"];
        var start_point = start_lat + ', ' + start_lng;

        // Prepare waypoints along route
        var waypts = [];

        for (var i = 1; i < waypoints.length; i++) {
            waypts.push({location: String(waypoints[i]["lat"]) + ', ' + String(waypoints[i]["lng"])})
        }

        // Create route, starting & ending at origin, passing through waypoints
        directionsService.route({
            origin: start_point,
            destination: start_point,
            waypoints: waypts,
            travelMode: 'BICYCLING'
        }, 

        // Error handling
        function(response, status) {
            if (status === 'OK') {
                directionsDisplay.setDirections(response);
            } else {
                console.log('Directions request failed due to ' + status);
            }
        });
    }

</script>

{% endblock %}